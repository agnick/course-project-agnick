# Security & Quality Non-Functional Requirements

| ID         | Название                      | Описание                                                                                    | Метрика/Порог                                  | Проверка (чем/где)                                  | Компонент        | Приоритет |
|------------|-------------------------------|---------------------------------------------------------------------------------------------|------------------------------------------------|-----------------------------------------------------|------------------|-----------|
| **NFR-01** | Защищённый доступ к API       | Все эндпоинты `/wishes*` требуют валидный `X-Auth-Token`. Неавторизованные — 401.           | 100% неавторизованных → HTTP 401               | Pytest e2e (`test_unauthorized_access_returns_401`) | AuthN/AuthZ      | High      |
| **NFR-02** | Валидация входных данных      | Все поля `Wish` валидируются Pydantic; ошибки — 422 в едином JSON `{error:{code,message}}`. | 100% ошибок формата → 422 + JSON               | Pytest контракт-тесты                               | API Layer        | Medium    |
| **NFR-03** | Единый формат ошибок          | Любая ошибка возвращается как `{error:{code,message}}` без стека.                           | 100% ответов по схеме                          | e2e + аудит логов CI                                | Core / Errors    | High      |
| **NFR-04** | Производительность сортировки | `/wishes/sorted`: p95 ≤ **200 мс** при **30 RPS** (stage, 5 мин).                           | p95 ≤ 200 мс @ 30 RPS                          | Locust/JMeter отчёт + CI артефакт                   | API Layer        | Medium    |
| **NFR-05** | Уязвимости зависимостей       | High/Critical CVE устраняются ≤ **7 дней** с момента обнаружения.                           | SLA ≤ 7 дней                                   | Dependabot/Snyk отчёт в CI                          | CI/CD            | High      |
| **NFR-06** | Консистентность `_DB`         | CRUD атомарны: при исключениях данные не дублируются/не теряются.                           | 0 повреждённых записей в тестах                | Unit + Fault Injection тест                         | Core / DB        | High      |
| **NFR-07** | Логирование без PII           | Ошибки пишутся в `uvicorn.error` без PII (email, токены, пароли).                           | 100% логов без PII                             | Лог-аудит, тест паттернов в CI                      | Core / Logging   | Medium    |
| **NFR-08** | Healthcheck latency           | `/health` отвечает < **100 мс**.                                                            | p95 ≤ 100 мс                                   | Pytest + мониторинг (Prometheus/Grafana)            | Health           | Low       |
| **NFR-09** | Хранение паролей (Argon2id)   | При добавлении Auth: пароли хранить как **Argon2id** с параметрами.                         | t=3, m=256MiB, p=1; 100% учёток                | Unit-тест конфигурации и проверки хеша              | Auth (в будущем) | High      |
| **NFR-10** | TTL/JWT токенов               | Миграция на **JWT (HS256)** с `exp` ≤ **60 мин** и ревокацией.                              | 0% просроченных/отозванных токенов принимается | e2e: 401 после `exp`; ревокация — 401               | Auth (в будущем) | High      |
