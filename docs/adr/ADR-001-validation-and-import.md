# ADR-001: Безопасная валидация данных и импорт JSON
Дата: 2025-10-19
Статус: Accepted

## Context
Сервис Wishlist позволяет пользователю импортировать JSON‑бэкап желаний через `app/routers/wishes/import_wishes`.
Без ограничений на размер, структуру и тип данных возможно повреждение `_DB` (Tampering) или DoS‑атака.
Реализованная модель `Wish` использует Pydantic с жёсткими ограничениями (`min_length`, `max_length`, `ge`), что удовлетворяет **NFR‑02**.
Дополнительно нужно ввести лимит размера и валидацию структуры входных данных, чтобы закрыть риск **R9** из модели угроз.

## Decision
1. Сохраняем строгую Pydantic‑валидацию во всех эндпоинтах (`title`, `price_estimate`, `notes`).
2. Добавляем ограничение на размер JSON при импорте (`len(data['backup']) ≤ 5000`).
3. При переходе к загрузкам файлов — проверка magic bytes, UUID‑имена, запрет симлинков.
4. Все некорректные данные возвращают 422 с `{error:{code,message}}` (см. ADR‑002).

## Alternatives
| Вариант                             | Плюсы            | Минусы                    |
|-------------------------------------|------------------|---------------------------|
| Проверка только типов Pydantic      | Просто           | Нет лимитов, риск DoS     |
| Использовать `orjson` без схемы     | Быстро           | Потеря контроля структуры |
| Ограничение на уровне reverse‑proxy | Снижает нагрузку | Не защищает _DB логику    |

## Consequences
- (+) Минимизация DoS при импорте.
- (+) Повышение надёжности данных `_DB`.
- (–) Возможны отказы при импорте больших файлов (user friction).

## Security impact
- STRIDE: **T — Tampering**, **D — Denial of Service**
- Threats: **R2, R9**
- NFR: **NFR‑02, NFR‑06**
- KPI: импорт ≤ 2 МБ, 0 битых записей.

## Rollout plan
1. Добавить ограничение длины `data['backup']`.
2. Добавить тесты `test_import_too_large` и `test_invalid_json_schema`.
3. Ввести лог‑метрику размера загрузок в CI.

## Links
- `app/routers/wishes.py`
- `app/models/wish.py`
- `RISKS.md → R2, R9`
- `STRIDE.md → F7`
- `NFR.md → NFR‑02, NFR‑06`
- `tests/test_import_limits.py`
